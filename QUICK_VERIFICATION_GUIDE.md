# 快速验收指南 - 5分钟验证分阶段工作流

## 🚀 前置条件

确保以下服务正在运行：

```bash
# 检查后端 (应返回 {"success":true,...})
curl http://localhost:8888/api/v1/status

# 检查前端 (应显示Vite dev server)
# 访问 http://localhost:3001
```

如果服务未运行：
```bash
# 启动后端
cd backend && uv run uvicorn app.main:app --host 0.0.0.0 --port 8888 --reload

# 启动前端(新终端)
cd frontend-x && npm run dev
```

---

## 📋 验收测试步骤

### 测试1: 后端API验证 (2分钟)

**目的**: 确认3个新API端点正常工作

```bash
cd backend

# 运行自动化测试
uv run python test_full_workflow.py
```

**预期结果**:
```
✅ 阶段1成功 (耗时: 10-15秒)
✅ 阶段2成功 (耗时: 35-45秒)
✅ 阶段3成功 (耗时: 65-80秒)
总耗时: 120-140秒

✅ 所有阶段均支持用户编辑和修改
✅ 后续阶段正确使用了前面阶段的输出
✅ 人工参与式工作流验证通过
```

---

### 测试2: 前端UI验证 (3分钟)

**目的**: 验证用户界面和交互流程

#### 步骤1: 创建课程
1. 访问 `http://localhost:3001`
2. 点击"创建新课程"或类似入口
3. 填写课程信息：
   ```
   课程主题: AI图像生成创作
   课程描述: 使用Stable Diffusion探索AI艺术
   年龄段: 14-16岁
   时长: 4天
   ```
4. 提交进入课程设计页面

#### 步骤2: 阶段1 - 项目基础定义
1. 页面应显示 **阶段1的面板**，其他阶段隐藏
2. 点击 **"开始生成"** 按钮
3. 观察：
   - ✅ 显示加载动画 "AI正在生成项目基础定义..."
   - ✅ 显示预估时间 "预计需要10-30秒"
4. 等待生成完成(约10-15秒)
5. 检查：
   - ✅ 文本域显示生成的Markdown内容
   - ✅ 内容包含"驱动性问题"、"项目定义"、"最终成果"
   - ✅ 文本域为**只读状态**(灰色背景)
   - ✅ 显示 **"编辑"** 按钮

#### 步骤3: 编辑功能测试
1. 点击 **"编辑"** 按钮
2. 检查：
   - ✅ 文本域变为**可编辑**(白色背景、蓝色边框)
   - ✅ 显示 **"保存修改"** 和 **"取消"** 按钮
3. 修改一些文本(例如修改驱动性问题)
4. 点击 **"保存修改"**
5. 检查：
   - ✅ 文本域恢复只读状态
   - ✅ 修改的内容已保存

#### 步骤4: 阶段2 - 评估框架设计
1. 点击 **"确认完成，继续下一阶段"**
2. 检查：
   - ✅ 阶段1面板的进度图标变为绿色✅
   - ✅ 阶段2面板出现
3. 点击阶段2的 **"开始生成"**
4. 等待生成(约35-45秒)
5. 检查：
   - ✅ 生成评估量规(Markdown表格格式)
   - ✅ 同样支持编辑功能

#### 步骤5: 阶段3 - 学习蓝图生成
1. 确认阶段2，进入阶段3
2. 点击 **"开始生成"**
3. 等待生成(约65-80秒)
4. 检查：
   - ✅ 生成逐日教学计划
   - ✅ 包含Day 1, Day 2等详细活动

#### 步骤6: 导出功能
1. 阶段3完成后，检查：
   - ✅ 显示 **"🎉 课程设计已完成！"** 提示
   - ✅ 显示 **"导出为Markdown文件"** 按钮
2. 点击导出按钮
3. 检查：
   - ✅ 浏览器下载一个 `.md` 文件
   - ✅ 文件名类似 `AI图像生成创作-PBL课程设计-1727732475123.md`
   - ✅ 打开文件，包含完整的3阶段内容

---

## ✅ 验收标准

### 必须通过 (P0)
- [x] 后端3个API端点正常返回数据
- [x] 前端能成功调用3个阶段的生成
- [x] 每个阶段都可以编辑内容
- [x] 阶段2使用编辑后的阶段1内容
- [x] 阶段3使用编辑后的阶段1+2内容
- [x] 导出功能正常工作
- [x] 没有Console错误

### 应该通过 (P1)
- [ ] 加载状态动画流畅
- [ ] 错误提示清晰(如果生成失败)
- [ ] 页面响应速度快(<3秒首屏)

### 可以优化 (P2)
- [ ] 移动端适配
- [ ] 导出多种格式(PDF, DOCX)
- [ ] 内容持久化(刷新不丢失)

---

## 🐛 常见问题排查

### 问题1: 后端返回 `{"detail":"'content'"}`
**原因**: 有多个后端进程在运行，请求打到了旧代码
**解决**:
```bash
# 杀掉所有Python进程
taskkill //F //IM python.exe

# 重新启动后端
cd backend && uv run uvicorn app.main:app --host 0.0.0.0 --port 8888 --reload

# 等待5秒，再测试
```

### 问题2: 前端显示 "生成失败"
**原因**:
1. 后端未启动 (检查 http://localhost:8888/api/v1/status)
2. AI服务API Key未配置或余额不足
3. 网络超时

**解决**:
```bash
# 检查环境变量
echo $PBL_AI_API_KEY

# 如果为空，设置环境变量
# backend/.env 文件中添加:
PBL_AI_API_KEY=your_actual_api_key
PBL_AI_MODEL=deepseek-chat
PBL_AI_BASE_URL=https://your-ai-service-url/v1
```

### 问题3: 生成超时
**原因**: AI服务响应慢或网络不稳定
**解决**:
- 等待更长时间(Stage3可能需要90秒)
- 检查AI服务是否正常
- 考虑增加timeout设置(backend/app/agents/stage_agents.py)

---

## 📸 预期截图

### 阶段1 - 生成中
```
┌────────────────────────────────────┐
│ 阶段1: 项目基础定义              │
├────────────────────────────────────┤
│                                    │
│   🔄 AI正在生成项目基础定义...     │
│   预计需要10-30秒                  │
│                                    │
└────────────────────────────────────┘
```

### 阶段1 - 生成完成(只读)
```
┌────────────────────────────────────┐
│ 阶段1: 项目基础定义      [编辑]   │
├────────────────────────────────────┤
│ ╔══════════════════════════════╗   │
│ ║ # 驱动性问题                 ║   │
│ ║ 如何用AI创作...              ║   │
│ ║                              ║   │
│ ║ # 项目定义                   ║   │
│ ║ 学生将学习...                ║   │
│ ╚══════════════════════════════╝   │
│                                    │
│ [确认完成，继续下一阶段]           │
└────────────────────────────────────┘
```

### 完成后
```
┌────────────────────────────────────┐
│ 🎉 课程设计已完成！                │
│                                    │
│ 您已经完成了所有3个阶段的设计。    │
│ 现在可以导出完整的课程方案。       │
│                                    │
│ [📥 导出为Markdown文件]            │
└────────────────────────────────────┘
```

---

## 🎯 验收结论

**如果以上测试全部通过，则证明:**

✅ **后端分阶段架构**正常工作
✅ **前端人工参与流程**正确实现
✅ **数据流向**符合设计(编辑后内容正确传递)
✅ **用户体验**流畅(状态提示、编辑功能、导出功能)
✅ **核心需求**已完成:从一次性生成改造为分阶段人工参与式工作流

**项目已达到交付标准！🚀**